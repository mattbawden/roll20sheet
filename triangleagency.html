<div class="grid biggap">

    <img src="https://raw.githubusercontent.com/mattbawden/roll20sheet/main/triangleagencylogo.png" />

    <div class="grid col2-roll">
        <div class="grid col2">
            <div class="grid col1">
                <label>Character Name</label>
                <input type="text" name="attr_charactername" value="" />
                <label>Agency Title</label>
                <input type="text" name="attr_agencytitle" value="" />
                <label>Agency Standing</label>
                <input type="text" name="attr_agencystanding" value="" />
                <label>Pronouns</label>
                <input type="text" name="attr_pronouns" value="" />
            </div>
            <div class="grid col2-arc">
                <div class="grid col1-arc">
                    <img src="https://raw.githubusercontent.com/mattbawden/roll20sheet/main/anomalylogonew.png" />
                    <img src="https://raw.githubusercontent.com/mattbawden/roll20sheet/main/realitylogo.png" />
                    <img src="https://raw.githubusercontent.com/mattbawden/roll20sheet/main/competencylogo.png" />
                </div>
                <div class="grid col1-arc">
                    <select name="attr_anomaly">
                        <option value="">Choose</option>
                        <option value="Whisper">Whisper</option>
                        <option value="Catalogue">Catalogue</option>
                        <option value="Drain">Drain</option>
                        <option value="Timepiece">Timepiece</option>
                        <option value="Growth">Growth</option>
                        <option value="Gun">Gun</option>
                        <option value="Dream">Dream</option>
                        <option value="Manifold">Manifold</option>
                        <option value="Absence">Absence</option>
                    </select>
                    <select name="attr_reality">
                        <option value="">Choose</option>
                        <option value="Caretaker">Caretaker</option>
                        <option value="Overbooked">Overbooked</option>
                        <option value="Pursued">Pursued</option>
                        <option value="Star">Star</option>
                        <option value="Struggling">Struggling</option>
                        <option value="Newborn">Newborn</option>
                        <option value="Romantic">Romantic</option>
                        <option value="Backbone">Backbone</option>
                        <option value="Creature">Creature</option>
                    </select>
                    <select name="attr_competency">
                        <option value="">Choose</option>
                        <option value="PR">PR</option>
                        <option value="RnD">R&D</option>
                        <option value="Barista">Barista</option>
                        <option value="CEO">CEO</option>
                        <option value="Intern">Intern</option>
                        <option value="Gravedigger">Gravedigger</option>
                        <option value="Reception">Reception</option>
                        <option value="Hotline">Hotline</option>
                        <option value="Clown">Clown</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="grid col2">
        <div class="grid col3-other">
            <img src="https://raw.githubusercontent.com/mattbawden/roll20sheet/main/commendationlogo.png" />
            <input type="number" name="attr_commendations" value="0" />
            <label>Commendations</label>
            <img src="https://raw.githubusercontent.com/mattbawden/roll20sheet/main/demeritlogo.png" />
            <input type="number" name="attr_demerits" value="0" />
            <label>Demerits</label>
            <img src="https://raw.githubusercontent.com/mattbawden/roll20sheet/main/burnoutlogo.png" />
            <input type="number" name="attr_addburnout" value="0" />
            <label>Additional Burnout</label>
        </div>
        <div class="grid col1">
            <h2>Quality Assurances</h2>
            <div class="grid col4-qa">
                <label></label>
                <label>Max</label>
                <label>Current</label>
                <label>Roll</label>
            </div>
            <div class="grid col4-qa">
                <label>Attentiveness</label>
                <input type="number" name="attr_attentivenessmax" value="0" />
                <input type="number" name="attr_attentiveness" value="0" />
                <button class="sheet-d4-dice" type="roll" name="roll_attentiveness" value="&{template:custom} {{standardroll=true}} {{title=Quality | Attentiveness}} {{subtitle=@{charactername}}} {{Result=[[6d4=3]]}}" />
            </div>
            <div class="grid col4-qa">
                <label>Duplicity</label>
                <input type="number" name="attr_duplicitymax" value="0" />
                <input type="number" name="attr_duplicity" value="0" />
                <button class="sheet-d4-dice" type="roll" name="roll_duplicity" value="&{template:custom} {{standardroll=true}} {{title=Quality | Duplicity}} {{subtitle=@{charactername}}} {{Result=[[6d4=3]]}}" />
            </div>
        </div>
    </div>

    <div class="grid col1-quirks">
        <h2>Quirks</h2>
        <div class="grid col3">
            <label>Quirk</label>

            <label>Description</label>

            <label>Type</label>
        </div>
        <fieldset class="repeating_abilities">
            <div class="grid col3">
                <input type="text" name="attr_quirkname" value="" />

                <input type="text" name="attr_quirkdesc" value="" />

                <select name="attr_quirktype">
                    <option value="">Choose</option>
                    <option value="positive">Positive</option>
                    <option value="negative">Negative</option>
                </select>
            </div>
        </fieldset>
    </div>

    <div class="grid col1-weapons">
        <h2>Combat Weapons</h2>
        <div class="grid col6-weapons">
            <label>Name</label>

            <label>Skill Type</label>

            <label>Stat</label>

            <label>Rank</label>

            <label>Item Mod</label>

            <label>DR</label>
        </div>
        <fieldset class="repeating_weapons">
            <div class="grid col6-weapons">
                <input type="text" name="attr_weaponname" value="" />

                <select name="attr_skilltype">
                    <option value="">Choose</option>
                    <option value="bow">Bow</option>
                    <option value="crossbow">Crossbow</option>
                    <option value="spring">Spring</option>
                    <option value="thrown">Thrown</option>
                    <option value="smallblades">Small Blades</option>
                    <option value="largeblades">Large Blades</option>
                    <option value="hafted">Hafted</option>
                    <option value="2hblades">2H Blades</option>
                    <option value="2hhafted">2H Hafted</option>
                    <option value="flails">Flails</option>
                    <option value="polearms">Polearms</option>
                    <option value="brawling">Brawling</option>
                    <option value="assassinate">Assassinate</option>
                </select>

                <select name="attr_weaponstat">
                    <option value="@{combatrating}">CCR</option>
                    <option value="@{rangedcr}">RCR</option>
                </select>

                <!--
                <input type="text" list="abilityScores" name="attr_weaponstat">
                <datalist id="abilityScores">Attribute
                    <option value="@{combatrating}">CCR</option>
                    <option value="@{rangedcr}">RCR</option>
                </datalist>
                -->

                <input type="number" name="attr_weaponskillrank" value="0" />

                <input type="number" name="attr_weaponitemmod" value="0" />

                <input type="number" name="attr_weapondr" value="0" />

                <button type="roll" name="roll_attack" class="weapatk" value="&{template:custom} {{attackroll=true}} {{title=Attack | @{weaponname}}} {{subtitle=@{charactername}}} {{Result=[[1d20 + @{weaponstat} [Attribute] + @{weaponskillrank} [Skill] + @{weaponitemmod} [Item Mod] + ?{Modifiers? Multiple Actions(-5)?|0} [Modifiers] - ?{DoD|0} [DoD]]]}} {{Base Damage=[[@{weapondr}]]}} {{Strength Damage=[[@{strength}]]}}" />
            
                <button type="roll" name="roll_parry" class="weappar" value="&{template:custom} {{parryroll=true}} {{title=Parry | @{weaponname}}} {{subtitle=@{charactername}}} {{Result=[[1d20 + @{weaponstat} [Attribute] + @{weaponskillrank} [Skill] + @{weaponitemmod} [Item Mod] + ?{Modifiers? Multiple Actions(-5)?|0} [Modifiers] - ?{DoD|0} [DoD]]]}}" />
            </div>
        </fieldset>
    </div>

    <div class="grid col1-equipment">
        <h2>Equipment</h2>
        <div class="grid col6-equipment">
            <label>Name</label>

            <label>Type</label>

            <label>Min STR</label>

            <label>DR/PR</label>

            <label>Max DR</label>

            <label>Range</label>
        </div>
        <fieldset class="repeating_equipment">
            <div class="grid col6-equipment">
                <input type="text" name="attr_equipname" value="" />

                <select name="attr_equiptype">
                    <option value="">Choose</option>
                    <option value="general">General</option>
                    <option value="parry">Parry</option>
                    <option value="armour">Armour</option>
                    <option value="bow">Bow</option>
                    <option value="crossbow">Crossbow</option>
                    <option value="spring">Spring</option>
                    <option value="thrown">Thrown</option>
                    <option value="smallblades">Small Blades</option>
                    <option value="largeblades">Large Blades</option>
                    <option value="hafted">Hafted</option>
                    <option value="2hblades">2H Blades</option>
                    <option value="2hhafted">2H Hafted</option>skillname
                    <option value="flails">Flails</option>
                    <option value="polearms">Polearms</option>
                    <option value="brawling">Brawling</option>
                    <option value="assassinate">Assassinate</option>
                    <option value="unique">Special Equipment</option>
                </select>

                <input type="number" name="attr_minstr" value="" />

                <input type="number" name="attr_drpr" value="" />

                <input type="number" name="attr_maxdr" value="" />

                <input type="number" name="attr_range" value="" />
            </div>
        </fieldset>
    </div>
</div>

<rolltemplate class="sheet-rolltemplate-custom">
    <div class="sheet-container sheet-color-{{color}}">
        <div class="sheet-header">
            {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
            {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
        </div>
        <div class="sheet-content">
            {{#allprops() title subtitle desc color standardroll attackroll critroll pursuitroll reactionroll dodgeroll parryroll grappleatkroll grappleescroll}}
            <div class="sheet-key">{{key}}</div>
            <div class="sheet-value">{{value}}</div>
            {{/allprops() title subtitle desc color standardroll attackroll critroll pursuitroll reactionroll dodgeroll parryroll grappleatkroll grappleescroll}}
            {{#standardroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Failure! Add 6 Chaos to pool</span>{{/rollLess() Result 1}}
                    {{#rollTotal() Result 1}}<span class="sheet-fullsuccess">Success, add 5 Chaos to pool</span>{{/rollTotal() Result 1}}
                    {{#rollTotal() Result 2}}<span class="sheet-fullsuccess">Success, add 4 Chaos to pool</span>{{/rollTotal() Result 2}}
                    {{#rollTotal() Result 3}}<span class="sheet-critical">Triscendence! No Chaos is added</span>{{/rollTotal() Result 3}}
                    {{#rollTotal() Result 4}}<span class="sheet-fullsuccess">Success, add 2 Chaos to pool</span>{{/rollTotal() Result 4}}
                    {{#rollTotal() Result 5}}<span class="sheet-fullsuccess">Success, add 1 Chaos to pool</span>{{/rollTotal() Result 5}}
                    {{#rollTotal() Result 6}}<span class="sheet-fullsuccess">Success, no Chaos is added</span>{{/rollTotal() Result 6}}
                </div>{{/Result}}
            {{/standardroll}}
            {{^standardroll}}
                {{#attackroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap!</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure!</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - half damage (rounded up)</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success!</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! Opponent must roll Critical Hit</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/attackroll}}
                {{#critroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap! You are unconscious</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure! You are unconscious</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - minus 5 to all rolls</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success! You are unhindered</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! You are unhindered</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/critroll}}
                {{#pursuitroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap! You fall and injure yourself, you cannot continue</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure! You stumble and fall, try again next round</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - you travel half your Movement Rate</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success! You travel your Movement Rate</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! Increase Movement Rate by 50ft</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/pursuitroll}}
                {{#reactionroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap! They will slander or mug you</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure! You have been ignored</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - you will need to pay a bribe</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success! You get the info or aid</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! You get additional info or aid</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/reactionroll}}
                {{#dodgeroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap! Off balance, opponent gets +2 to hit</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure! Attacker rolls to hit</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - attacker rolls to hit</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success! Attack is dodged</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! Attack is dodged and you get +2 to attack next round</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/dodgeroll}}
                {{#parryroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap! Off balance, -2 to next action</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure! Attacker rolls to hit</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - attacker rolls to hit</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success! Attack is parried</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! Attack is parried</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/parryroll}}
                {{#grappleatkroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap! Opponent recieves +5 to next attack</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure! Failed to grab the defender</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - no leverage, cannot choke or throw and defender has +5 to escape</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success! Hold achieved, can choke or throw with next action</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! Strong hold, defender has -5 to escape</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/grappleatkroll}}
                {{#grappleescroll}}
                {{#Result}}<div class="sheet-result">
                    {{#rollLess() Result 1}}<span class="sheet-mishap">Mishap! You have -5 to the next attempt to escape</span>{{/rollLess() Result 1}}
                    {{#rollBetween() Result 1 5}}<span class="sheet-failure">Failure! You remain in the hold</span>{{/rollBetween() Result 1 5}}
                    {{#rollBetween() Result 6 10}}<span class="sheet-partialsuccess">Partial Success - you loosen the hold and have +5 to your next escape</span>{{/rollBetween() Result 6 10}}
                    {{#rollBetween() Result 11 19}}<span class="sheet-fullsuccess">Full Success! You escape the hold</span>{{/rollBetween() Result 11 19}}
                    {{#rollGreater() Result 19}}<span class="sheet-critical">Critical! Perfect reversal, make an immediate grapple attack or move away</span>{{/rollGreater() Result 19}}
                </div>{{/Result}}
                {{/grappleescroll}}
            {{/standardroll}}
            {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
        </div>
    </div>
</rolltemplate>

<script type="text/worker">

    on("change:repeating_skills:skillrank", function(eventinfo) {
        getAttrs(["repeating_skills_skillname"], function(values) {
            let updateValue = 0;
            if(values.repeating_skills_skillname == "evade") {
                updateValue = eventinfo.newValue;
                setAttrs({
                    "charEvade": updateValue
                });
            }
            else if(values.repeating_skills_skillname == "acrobatics") {
                updateValue = eventinfo.newValue;
                setAttrs({
                    "charAcrobatics": updateValue
                });
            }
            else if(values.repeating_skills_skillname == "guard") {
                updateValue = eventinfo.newValue;
                setAttrs({
                    "charGuard": updateValue
                });
            }
            else if(values.repeating_skills_skillname == "brawling") {
                updateValue = eventinfo.newValue;
                setAttrs({
                    "charBrawl": updateValue
                });
            }            
        });
    });

    on("change:repeating_weapons:skilltype", function(eventinfo) {

        const skilltype = eventinfo.newValue;
        console.log(skilltype);
        const rowid = eventinfo.sourceAttribute;
        console.log(rowid);
        let attrlength = rowid.length;
        attrlength = attrlength - 9;
        let updateid = rowid.substr(0,attrlength);
        const weapskillrank = updateid.concat("weaponskillrank");
        console.log(weapskillrank);

        setAttrs({
            repeating_weapons_weaponskillrank: 0
        });

        getSectionIDs('skills',function(idarray) {
            const skillnames = [];
            idarray.forEach(id => skillnames.push(`repeating_skills_${id}_skillname`));
            console.log(skillnames);

            getAttrs(skillnames, function(values) {
                console.log(values);
                console.log(eventinfo.newValue);
                Object.keys(values).forEach(key => {
                    console.log(key + ", " + values[key]);
                    console.log(skilltype);
                    if(values[key] == skilltype) {
                        const skillid = key;
                        console.log(skillid);
                        let length = skillid.length;
                        length = length - 9;
                        let repeatid = skillid.substr(0,length);
                        const skillrank = repeatid.concat("skillrank");
                        console.log(skillrank);
                        getAttrs([skillrank], function(values) {
                            console.log(values);
                            console.log(values[skillrank]);
                            setAttrs({
                                repeating_weapons_weaponskillrank: values[skillrank]
                            });
                        });
                    }
                });
            });
        });
    
    });
    
</script>